Bootstrap: docker
From: intel/oneapi-hpckit:2025.3.0-0-devel-ubuntu22.04


################################################################################
%labels
################################################################################

Maintainer      Jason Li
Version         ???
Description     Roshambo is a python package for robust Gaussian molecular shape comparison


################################################################################
%environment
################################################################################

export RDBASE=/opt/rdkit-Release_2024_03_6
export RDKIT_LIB_DIR=$RDBASE/lib
export RDKIT_INCLUDE_DIR=$RDBASE/Code
export RDKIT_DATA_DIR=$RDBASE/Data
export PYTHONPATH=$PYTHONPATH:$RDBASE
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$RDBASE/lib
export CUDA_HOME=/usr/local/cuda-12
#export I_MPI_PMI_LIBRARY=/usr/lib/x86_64-linux-gnu/libpmi2.so


################################################################################
%post
################################################################################

# Install CUDA 12.2 (Package is old. 13.0+ does not work)
cd /opt
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && dpkg -i cuda-keyring_1.1-1_all.deb && rm cuda-keyring_1.1-1_all.deb
apt update && DEBIAN_FRONTEND="noninteractive" apt -y install cuda-12-2 pip sqlite3 libsqlite3-dev libboost-dev libboost-all-dev libfreetype-dev libeigen3-dev && apt clean
pip install joblib tqdm requests biopython mpi4py IPython numpy && pip cache purge

# Install rdkit 2024_03_6
#   Too old: Attempts to manually download a font that no longer exists.
#   Too new: Does not play well with the dependency versions in this package
cd /opt
wget https://github.com/rdkit/rdkit/archive/refs/tags/Release_2024_03_6.tar.gz && tar -xf Release_2024_03_6.tar.gz && rm Release_2024_03_6.tar.gz
cd rdkit-Release_2024_03_6
mkdir build
cd build
cmake -DRDK_BUILD_INCHI_SUPPORT=ON .. && make -j`nproc` && make install

# Install Roshambo
export RDBASE=/opt/rdkit-Release_2024_03_6
export RDKIT_LIB_DIR=$RDBASE/lib
export RDKIT_INCLUDE_DIR=$RDBASE/Code
export RDKIT_DATA_DIR=$RDBASE/Data
export PYTHONPATH=$PYTHONPATH:$RDBASE
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$RDBASE/lib
export CUDA_HOME=/usr/local/cuda-12
cd /opt
git clone https://github.com/rashatwi/roshambo.git
cd roshambo
pip install -e . && pip cache purge
