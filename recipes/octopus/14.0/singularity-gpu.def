Bootstrap: docker
From: nvidia/cuda:12.4.1-devel-ubuntu22.04


################################################################################
%labels
################################################################################

Maintainer      Jason Li
Version         14.0
Description     


################################################################################
%environment
################################################################################

export PATH=/opt/openmpi/4.1.2/bin:$PATH
export LD_LIBRARY_PATH=/opt/openmpi/4.1.2/lib:/usr/local/lib:/usr/local/cuda/lib64:/usr/local/cuda-12.4/compat/:$LD_LIBRARY_PATH


################################################################################
%post
################################################################################

# Set up environment
export VERSION_OCTOPUS=14.0
export BUILD_SYSTEM=autotools
export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/cuda/lib64:/usr/local/cuda-12.4/compat/:$LD_LIBRARY_PATH

# Obtain installation scripts
apt update
apt install -y wget
cd /opt/
wget https://raw.githubusercontent.com/lsuhpchelp/singularity/main/recipes/octopus/14.0/install_dependencies.sh
wget https://raw.githubusercontent.com/lsuhpchelp/singularity/main/recipes/octopus/14.0/install_octopus.sh

# Install Octopus
bash /opt/install_dependencies.sh
bash /opt/install_octopus.sh --version $VERSION_OCTOPUS --download_dir /opt/octopus --build_system $BUILD_SYSTEM

# Install OpenMPI w/ PMI2
apt install -y build-essential
apt install -y wget hwloc libpmi2-0 libpmi2-0-dev
wget https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.2.tar.gz
tar zxvf openmpi-4.1.2.tar.gz && rm openmpi-4.1.2.tar.gz
cd openmpi-4.1.2
./configure --with-hwloc=internal --prefix=/opt/openmpi/4.1.2 --with-slurm \
    --with-pmi=/usr --with-pmi-libdir=/usr/lib/x86_64-linux-gnu --without-verbs
make -j $(nproc)
make install

# Cleanup
apt clean
rm -rf /var/lib/apt/lists/*
